---
- name: Starting Role {{ role_name }}
  ansible.builtin.debug:
    msg: "DEBUG: {{ role_name }}"

- name: Install required packages
  ansible.builtin.package:
    name:
      - git
      - bash
      - jq
    state: present

- name: Create directory for repository
  ansible.builtin.file:
    path: "{{ health_check_repo_dir }}"
    state: directory
    mode: '0755'

- name: Clone or update repository
  ansible.builtin.git:
    repo: "{{ health_check_repo_url }}"
    dest: "{{ health_check_repo_dir }}"
    version: main
    update: true
    force: true

- name: Make health check script executable
  ansible.builtin.file:
    path: "{{ health_check_repo_dir }}/{{ health_check_script }}"
    mode: '0755'

- name: Copy custom health check config from local host
  ansible.builtin.copy:
    src: health_check.json
    dest: "{{ health_check_config_path }}"
    mode: '0644'
    force: true

- name: Run health check
  ansible.builtin.command: "{{ health_check_repo_dir }}/{{ health_check_script }} -q --config {{ health_check_config_path }}"
  register: health_check_result
  failed_when: false
  changed_when: false

- name: Process health check results
  ansible.builtin.set_fact:
    health_check_status: "{{ 'PASS' if health_check_result.stdout is not search('check.*failed') else 'FAIL' }}"
    health_check_host_results: "{{ lookup('template', 'templates/health_check_output.j2') }}"
  vars:
    output_lines: "{{ health_check_result.stdout_lines }}"

# Simplified output - consolidate results into a single, color-coded summary
- name: Display health check summary
  ansible.builtin.debug:
    msg: "=========== HEALTH CHECK SUMMARY ==========="
  run_once: true
  delegate_to: "{{ play_hosts[0] }}"

- name: Collect failed hosts
  ansible.builtin.set_fact:
    health_check_failed_hosts: "{{ (health_check_failed_hosts | default([])) + [item] }}"
  when: hostvars[item].health_check_status == 'FAIL'
  loop: "{{ ansible_play_hosts_all }}"
  run_once: true
  delegate_to: "{{ play_hosts[0] }}"

- name: Display consolidated status
  ansible.builtin.debug:
    msg:
      - "PASSING: {{ ansible_play_hosts_all | difference(health_check_failed_hosts | default([])) | sort | join(', ') }}"
      - "{% if health_check_failed_hosts | default([]) %}FAILING: {{ health_check_failed_hosts | sort | join(', ') }}{% else %}No failures detected{% endif %}"
  run_once: true
  delegate_to: "{{ play_hosts[0] }}"
  failed_when: health_check_failed_hosts | default([]) | length > 0
